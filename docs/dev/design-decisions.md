# Design decisions

## Umbrella Glance Service (Split API deployment)

As mentioned in [OSSN-0090](https://wiki.openstack.org/wiki/OSSN/OSSN-0090),
when deploying Glance in a popular configuration where Glance shares a
common storage backend with Nova and/or Cinder, it is possible to open some
known attack vectors by which malicious data modification can occur. If you
choose to deploy a glance operator with Ceph as a backend then by default you
will get a split API (Internal Vs External Glance API) deployed.

- A ``user facing`` glance-api service, accessible via the Public and Admin
keystone endpoints.
- An ``internal facing only`` service, accessible via
the Internal keystone endpoint.

The user facing service is configured to not expose image locations, namely by
setting the following options in glance-api.conf:

```editorconfig
[DEFAULT]
show_image_direct_url = False
show_multiple_locations = False
```

The internal service, operating on a different port (e.g. 9293), is configured
identically to the public facing service, except for the following:

```editorconfig
[DEFAULT]
show_image_direct_url = True
show_multiple_locations = True
```

OpenStack services that use glance (cinder and nova) is configured to access
it via the new internal service. That way both cinder and nova will have
access to the image location data.


## Enable Per Tenant Quotas

Glance supports resource consumption quotas on tenants through the use of
Keystoneâ€™s unified limits functionality. In order to enable this feature, as
per the [official
documentation](https://docs.openstack.org/glance/latest/admin/quotas.html), the
`Glance CRD` exposes the `quotas` structure, where the limits defined in the
documentation can be defined. As the full [Glance example
CR](https://github.com/openstack-k8s-operators/glance-operator/blob/main/config/samples/glance_v1beta1_glance_quota.yaml)
shows, when the following is added in the top level definition, all the
`GlanceAPI` Pods will enable per tenant quotas via `use_keystone_limits =
True` in their config, that will be automatically generated by the `Glance`
operator.

```
apiVersion: glance.openstack.org/v1beta1
kind: Glance
metadata:
  name: glance
spec:
  ...
  ...
  quotas:
    imageSizeTotal: 1000
    imageStageTotal: 1000
    imageCountUpload: 100
    imageCountTotal: 100
```

As a follow up work, tha Glance operator might rely on the existing `webhooks`
to enforce the `Quota` Limits values.

## Cinder backend

When using the Cinder backend the Glance containers need to run with higher
privileges than with other backends, this is due to the usage of os-brick to
connect to volumes.

Some of the things that the operator does when using Cinder as a backend are:

- Run containers as privileged
- Mount for r/w more directories
- Pod shares the PID namespace with the host
- Run CLI commands with the binaries present in the host

OpenShift deployments are different from TripleO deployments.  For example, in
TripleO we run iscsid and multipathd daemons in containers and their client
side commands are in sync (version-wise) in the service containers.  It is also
required that there are no other daemons running in the host or other
containers.

In the OpenShift world this is different, iscsid and multipathd run on the host
and therefore their version won't be in sync with the one in the openstack
service containers, which means that they won't work correctly.

The reason why OpenShift runs iscsid and multipathd in the host is so that they
can be shared between the different things that may need it: OpenShift itself,
CSI plugins, and in this case also OpenStack services.

The way to use the host iscsi and multipath services is by exiting the pod
namespace and running the commands on the host namespace using `nsenter`. Even
if this may look nasty/weird, this is the recommended way by the storage
OpenShift team and what CSI plugins do.

We are using `nsenter` through the `templates/glance/bin/run-on-host` script.
This `run-on-host` script supports 2 ways of replacing commands: being copied
or symlinked. In our case we instruct kolla to use the copying mechanism in
`templates/glance/config/glance-api-config.json`.

To be able to use `nsenter` the pod needs to share the PID namespace with the
host.

## GlanceAPI deployment

When a Glance CR is created, at last two `GlanceAPI` deployments are triggered:

```
...
...
spec:
  serviceUser: glance
  databaseInstance: openstack
  databaseUser: glance
  glanceAPIInternal:
    ..
  glanceAPIExternal:
    ..
  secret: osp-secret
  storageClass: ""
...
...
```

Both `GlanceAPI` internal and external subCRs are generated, resulting in two
different k8s `Deployment` objects.
The Status and the definition of the GlanceAPI services within the control plane
can be retrieved with the following commands:

```
$ oc get Glance

NAME     STATUS   MESSAGE
glance   True     Setup complete

$ oc get GlanceAPI

NAME              NETWORKATTACHMENTS   STATUS   MESSAGE
glance-external                        True     Setup complete
glance-internal                        True     Setup complete
```

and they can be inspected as regular k8s objects.
Each GlanceAPI deployment resulting from the process above will deploy three
containers within the same Pod:

```
+-------------------------------------+
| GlanceAPI:Pod                       |
|                                     |
|   +-----------------------+         |
|   |   +------------+      |         |
|   |   | glance-log | -------------------> It streams the glance-api logs
|   |   +------------+      |         |     in /var/log/glance
|   +-----------------------+         |
|   +-----------------------+         |
|   |   +--------------+    |         |
|   |   | glance-httpd | ---|-------------> It intercepts requests on 9292 and
|   |   +-+------------+    |         |     do the ProxyPass to the process
|   |     |                 |         |     behind on 127.0.0.1:9293
|   |   +-+----------+      |         |
|   |   | glance-api | -----|-------------> Runs the glance-api process on 9293
|   |   +------------+      |         |
|   +-----+-----------------+         |
+---------|-----------------------------+
          |
          +-> GlanceAPI = (httpd + glance-api)
```

The reason about having an additional httpd layer relies on the fact that
`TLS` is not natively supported in Glance.
Even though Glance it's not supported in production as regular wsgi process
run by httpd, this scenario sees httpd configured in a way that executes
`ProxyPass` for the requests coming from the associated endpoint to the
glance-api service.

More details about this can be found in the
[upstream documentation](https://docs.openstack.org/glance/latest/admin/apache-httpd.html).
